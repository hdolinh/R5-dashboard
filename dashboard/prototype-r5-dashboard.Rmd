---
title: "R5 Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme:
      primary: "#217a38"
      secondary: "#24583b"
      success: "#96d4ac"
      info: "#2f5b75"
      warning: "#ffc734"
      danger: "#892f31"
      base_font:
        google: Nunito
      code_font:
        google: Fira Code
      heading_font:
        google: Nunito
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(mapview)
library(here)
library(sf)
library(vroom)
library(dplyr)
library(leaflet)
library(ggplot2)
library(scales)
library(tigris)
library(RColorBrewer)
library(zipcodeR)
library(shiny)
library(ggiraph)
# bslib::bs_themer()
```

```{r read in data}
# spatial 
r5_au_bounds <- read_sf(here("data/spatial/clean/"))

# ridb
usfs_ridb_all <- vroom(here("data/ridb/clean/usfs_ridb_all.csv"))
```


# Welcome {data-orientation=rows}

## Row

### Average increase in visits per year (2018-2021)

```{r tot res primary}
# average % change for reservations 2018-2021
nrow2021 <- nrow(filter(usfs_ridb_all, fy == 2021))
nrow2020 <- nrow(filter(usfs_ridb_all, fy == 2020))
nrow2019 <- nrow(filter(usfs_ridb_all, fy == 2019))
nrow2018 <- nrow(filter(usfs_ridb_all, fy == 2018))

delta_fy18 <- ((nrow2019 - nrow2018) / nrow2018) * 100
delta_fy19 <- ((nrow2020 - nrow2019) / nrow2019) * 100
delta_fy20 <- ((nrow2021 - nrow2020) / nrow2020) * 100

avg_delta <- (delta_fy18 + delta_fy19 + delta_fy20) / 3

valueBox(prettyNum(paste0(round(avg_delta, 0), "%"), 
                   decimal.mark = getOption("OutDec"), color = "primary"))
```

### Success Value Box

```{r}
valueBox(2, color = "success")
```

### Info Value Box

```{r}
valueBox(3, color = "info")
```

### Warning Value Box

```{r}
valueBox(4, color = "warning")
```

### Danger Value Box

```{r}
valueBox(5, color = "danger")
```

## Row 2 {data-width=350}

### Chart C {.no-title}

```{r}
shiny::radioButtons("year",
                    label = NULL,
                    choices = c(2018, 2019, 2020, 2021, "All"),
                    selected = "All",
                    inline =TRUE)

bw_df <- usfs_ridb_all %>% 
  filter(bookingwindow > 0,
         bookingwindow != "Inf") %>%
  select(fy, forestname, park, bookingwindow) %>%
  filter(!is.na(bookingwindow),
         forestname == "Angeles National Forest") %>% 
  group_by(fy, park) %>% 
  summarize(avg_bookingwindow = mean(bookingwindow))

bw_plot <- ggplot(data = bw_df, aes(x = park,
                                    y = avg_bookingwindow)) +
  geom_boxplot(color = "#628e6e") +
  geom_jitter(aes(color = fy),
              alpha = 0.3,
              size = 0.9) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip()+
  labs(
    x = NULL,
    y = "Average booking window (days)"
  )

bw_plot

# girafe(ggobj = bw_plot,
#        options = list(
#          opts_hover(css = "fill:black; stroke: yellow;"),
#          opts_hover_inv(css = "opacity:0.2;"),
#          opts_zoom(max = 10)
#          )
#        )
```

### Chart D

```{r}

```

# Rec-Sheds {data-orientation=rows}

<!-- test site: Convict Lake Campground in Inyo NF -->

```{r}
test <- usfs_ridb_all %>% 
  # Inyo NF
  filter(park == "Convict Lake Campground")

# 2021 FY data
usfs_ridb2021 <- usfs_ridb_all %>% filter(fy == 2021)
```


## Sidebar {.sidebar}

Who is visiting the USFS [Pacific Southwest Region](https://www.fs.usda.gov/r5) (R5)?

```{r}
selectInput("year", label = "Select a year:",
            choices = c(2018, 2019, 2020, 2021), selected = 2021)

selectInput("forest", label = "Select a forest:",
            choices = c(
              "Angeles National Forest",
              "Sierra National Forest",
              "Inyo National Forest",
              "Los Padres National Forest"
            ), 
            selected = "Inyo National Forest")

selectInput("park", label = "Select a site:",
            choices = c(
              "Reyes Creek Campground",
              "Mt. Pinos Campground",
              "Convict Lake Campground",
              "Silvertip Campground"
            ), 
            selected = 2021)
```


## Row 1

### Map {.no-title}

```{r}
# total reservations for Convict Lake Campground 
total_reservations <- nrow(test)

# number of reservations and % per state
map_data <- test %>%
  group_by(customerzip, state_full) %>%
  summarize(
    number_reservations = n(),
    percentage_reservations = percent((number_reservations / total_reservations), 
                                      accuracy = 0.01)
  ) %>%
  filter(!is.na(customerzip))
```


```{r}
# get state geometries
## -- ZIP codes and respective states -- ##
fips_list <-
  c(
    "01",
    "02",
    "04",
    "05",
    "06",
    "08",
    "09",
    "10",
    "11",
    "12",
    "13",
    "15",
    "16",
    "17",
    "18",
    "19",
    "20",
    "21",
    "22",
    "23",
    "24",
    "25",
    "26",
    "27",
    "28",
    "29",
    "30",
    "31",
    "32",
    "33",
    "34",
    "35",
    "36",
    "37",
    "38",
    "39",
    "40",
    "41",
    "42",
    "44",
    "45",
    "46",
    "47",
    "48",
    "49",
    "50",
    "51",
    "53",
    "54",
    "55",
    "56",
    "72"
  )
state_list <-
  c(
    "AL",
    "AK",
    "AZ",
    "AR",
    "CA",
    "CO",
    "CT",
    "DE",
    "DC",
    "FL",
    "GA",
    "HI",
    "ID",
    "IL",
    "IN",
    "IA",
    "KS",
    "KY",
    "LA",
    "ME",
    "MD",
    "MA",
    "MI",
    "MN",
    "MS",
    "MO",
    "MT",
    "NE",
    "NV",
    "NH",
    "NJ",
    "NM",
    "NY",
    "NC",
    "ND",
    "OH",
    "OK",
    "OR",
    "PA",
    "RI",
    "SC",
    "SD",
    "TN",
    "TX",
    "UT",
    "VT",
    "VA",
    "WA",
    "WV",
    "WI",
    "WY",
    "PR"
  )
states_names_list <-
  c(
    "Alabama",
    "Alaska",
    "Arizona",
    "Arkansas",
    "California",
    "Colorado",
    "Connecticut",
    "Delaware",
    "District of Columbia",
    "Florida",
    "Georgia",
    "Hawaii",
    "Idaho",
    "Illinois",
    "Indiana",
    "Iowa",
    "Kansas",
    "Kentucky",
    "Louisiana",
    "Maine",
    "Maryland",
    "Massachusetts",
    "Michigan",
    "Minnesota",
    "Mississippi",
    "Missouri",
    "Montana",
    "Nebraska",
    "Nevada",
    "New Hampshire",
    "New Jersey",
    "New Mexico",
    "New York",
    "North Carolina",
    "North Dakota",
    "Ohio",
    "Oklahoma",
    "Oregon",
    "Pennsylvania",
    "Rhode Island",
    "South Carolina",
    "South Dakota",
    "Tennessee",
    "Texas",
    "Utah",
    "Vermont",
    "Virginia",
    "Washington",
    "West Virginia",
    "Wisconsin",
    "Wyoming",
    "Puerto Rico"
  )

# create dataframe of states
df_states_fips <- as.data.frame(list(
  fips = fips_list,
  state = state_list,
  state_full = states_names_list
))

# loop through state df to get all ZIP codes w/in state
df_states_zip_codes <- data.frame()

for (i in seq_along(fips_list)) {
  state <- zipcodeR::search_fips(state_fips = fips_list[[i]]) %>%
    select(zipcode, state)
  df_states_zip_codes <- rbind(df_states_zip_codes, state)
}
# add full state name, fips code, etc. to list of all ZIP codes for each state
df_states_fips_zip_codes <-
  left_join(x = df_states_zip_codes,
            y = df_states_fips,
            by = "state") %>%
  select(fips, zipcode) %>%
  rename(zip_code = zipcode)

df_state_geometries_us <- tigris::states() %>% # defaults to 2021 data
  select(GEOID, STUSPS, NAME, geometry) %>%
  rename(fips = GEOID,
         state_abbrev = STUSPS,
         state = NAME) %>%
  rmapshaper::ms_simplify(keep = 0.005, keep_shapes = TRUE)  

## combine dfs ##
map_data_geometries <-
  df_state_geometries_us %>%
  left_join(map_data,
            by = c("state" = "state_full")) %>%
  mutate_at(vars(number_reservations),
            ~ replace(number_reservations, is.na(number_reservations), 0)) %>%
  mutate_at(vars(percentage_reservations),
            ~ replace(percentage_reservations, is.na(percentage_reservations), 0)) %>%
  select(state,
         number_reservations,
         percentage_reservations,
         geometry)

# transform to 4326 crs
map_data_geometries <- map_data_geometries %>% st_transform(crs = 4326)
```


```{r}
# location of site for point on map
site_location_map <- usfs_ridb2021 %>%
  group_by(park) %>%
  summarise(
    facilitylatitude = median(facilitylatitude),
    facilitylongitude = median(facilitylongitude)
  ) %>%
  filter(park == "Convict Lake Campground")
```




```{r}
r5_sites <- usfs_ridb_all %>%
  group_by(forestname,
           park,
           facilitylongitude,
           facilitylatitude) %>% 
  summarize(n = n()) %>% 
  select(!n) %>%
  st_as_sf(coords = c("facilitylongitude", "facilitylatitude"), crs = 4326)
```


```{r}
# transform to 4326 crs
r5_au_bounds <- r5_au_bounds %>% st_transform(crs = 4326)
```


```{r}
# mapview(list(r5_au_bounds, r5_sites))
```


```{r}
# # usfs map
# leaflet() %>% 
#   setView(lat = 36.7783, lng = -119.4179, # center of CA
#           zoom = 5.5) %>% 
#   addPolygons(
#     data = r5_au_bounds,
#     weight = 1
#   ) %>% 
#   addProviderTiles(
#     providers$CartoDB.Voyager
#     ) 
```


```{r}
camping_icon <- makeIcon(here("images/camping_location_icon.png"),
                         iconWidth = 25, iconHeight = 25)

leaflet() %>% 
  setView(lat = 49.850033, lng = -118.6500523, zoom = 3) %>% 
  addPolygons(
    data = map_data_geometries,
    weight = 1,
    fillColor = "purple",
    color = "white"
  ) %>% 
  addProviderTiles(
    providers$CartoDB.Voyager
    ) %>% 
  addMarkers(lng = site_location_map$facilitylongitude,
             lat = site_location_map$facilitylatitude,
             popup = site_location_map$park,
             icon = camping_icon)
```



## Row 2

### Total number of visits to selected site in 2021

```{r}
valueBox(prettyNum(nrow(test), big.mark = ","), 
         color = "success")
```


### Median cost of selected site in 2021

```{r}
# rm inf and neg values
cost_df <- test %>% 
  filter(is.infinite(dailycost) != TRUE) %>% 
  filter(dailycost > 0)

# NOTEHD: right skewed so using median
# ggplot(data = cost_df, aes(x = dailycost)) + geom_histogram()

median_cost <- median(cost_df$dailycost)

valueBox(paste0("$", median_cost),
         color = "warning")
```


### Number of people in reservation for selected site in 2021

```{r}
convictlake_2021 <- test %>% filter(fy == 2021)

mean_numofppl <-  mean(convictlake_2021$numberofpeople, na.rm = TRUE)

valueBox(round(mean_numofppl, 0), color = "info")
```





<!-- example code -->

```{r eval=FALSE}
# Total number of visits to R5 sites in 2021
r5_2021_visits <- usfs_ridb_all %>% filter(fy == 2021)

valueBox(prettyNum(nrow(r5_2021_visits), big.mark = ","), 
         color = "success")
```


```{r eval=FALSE}
# Most visited forest in 2021
most_visited_forest <- usfs_ridb_all %>% 
  filter(fy == 2021) %>% 
  count(forestname) %>% 
  filter(n == max(n))

valueBox(paste0(prettyNum(most_visited_forest$n, big.mark = ","),
                " visits to ",
                most_visited_forest$forestname),
         color = "info")
```


```{r eval=FALSE}
# Median cost in 2021

# rm inf and neg values
cost_df <- usfs_ridb2021 %>% 
  filter(is.infinite(dailycost) != TRUE) %>% 
  filter(dailycost > 0)

# NOTEHD: right skewed so using median
ggplot(data = cost_df, aes(x = dailycost)) + geom_histogram()

median_cost <- median(cost_df$dailycost)

valueBox(paste0("$", median_cost),
         color = "warning")
```
